#!/bin/bash

set -e

DOCKERFILE_PATH=${DOCKERFILE_PATH:-Dockerfile}
README_TEMPLATE_PATH=${README_TEMPLATE_PATH:-README.md.j2}
README_PATH=${README_PATH:-README.md}
RIOTKIT_PATH=${RIOTKIT_PATH:-./.helpers/}

if [[ ! -f "${DOCKERFILE_PATH}" ]] || [[ ! -f "${README_TEMPLATE_PATH}" ]]; then
    echo " >> Dockerfile or template does not exist"
    echo " >> Usage: DOCKERFILE_PATH=Dockerfile README_TEMPLATE_PATH=README.md.j2 README_PATH=README.md RIOTKIT_PATH=./bin ./bin/docker-generate-readme"
    exit 1
fi

# will produce DOCKERFILE_ENVS variable to include in j2cli
echo " >> Extracting env variables from Dockerfile"
cat "${DOCKERFILE_PATH}" | $RIOTKIT_PATH/extract-envs-from-dockerfile bash_source > .env.tmp;

echo " >> Importing into the shell"
source .env.tmp

echo " >> Rendering the file"
$RIOTKIT_PATH/env-to-json parse_json | j2 "${README_TEMPLATE_PATH}" -f json > .README.md.tmp

mv .README.md.tmp "${README_PATH}"
rm .env.tmp
